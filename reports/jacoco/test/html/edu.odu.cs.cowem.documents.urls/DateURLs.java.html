<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DateURLs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cowem-plugin</a> &gt; <a href="index.source.html" class="el_package">edu.odu.cs.cowem.documents.urls</a> &gt; <span class="el_source">DateURLs.java</span></div><h1>DateURLs.java</h1><pre class="source lang-java linenums">package edu.odu.cs.cowem.documents.urls;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.time.temporal.TemporalAccessor;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;

/**
 * Implements URL rewriting in course documents.
 * 
 *  [text](date:) where text is a date/time in ISO 8601 format
 *           YYYY-MM-DDThh:mm, is formatted so a span of class
 *           date with a more conventional format.
 * 
 *  No support at the moment for time zones. May add that later.
 *  
 * @author zeil
 *
 */
public class DateURLs implements SpecialURL {
    
     
    /**
     * For logging error messages.
     */
<span class="fc" id="L38">    private static Logger logger </span>
<span class="fc" id="L39">       = LoggerFactory.getLogger(DateURLs.class);</span>
    
    /**
     * Format used for rendering combined date-time items.
     */
<span class="fc" id="L44">    private static final DateTimeFormatter DT_OUTPUT_FORMAT </span>
<span class="fc" id="L45">        = DateTimeFormatter.ofPattern(&quot;MM/dd/yyyy, h:mma z&quot;);</span>

    /**
     * Format used for rendering combined dates.
     */
<span class="fc" id="L50">    private static final DateTimeFormatter D_OUTPUT_FORMAT </span>
<span class="fc" id="L51">        = DateTimeFormatter.ofPattern(&quot;MM/dd/yyyy&quot;);</span>

    /**
     * Format used for rendering combined times.
     */
<span class="fc" id="L56">    private static final DateTimeFormatter T_OUTPUT_FORMAT </span>
<span class="fc" id="L57">        = DateTimeFormatter.ofPattern(&quot;h:mma&quot;);</span>
    
    /**
     * Format used for rendering combined date-time attributes.
     */
<span class="fc" id="L62">    private static final DateTimeFormatter DT_ATTR_FORMAT </span>
<span class="fc" id="L63">        = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss z&quot;);</span>

    /**
     * Create a URL rewriter.
     * 
     */
<span class="fc" id="L69">    public DateURLs() {</span>
<span class="fc" id="L70">    }</span>

 
	/**
	 * Checks to see if a linking element (a or img) uses a special
	 * protocol label and, if so, attempts to rewrite the element.
	 * 
     * @param link an element containing a URL
     * @param linkAttr name of the attribute containing the URL 
     * @return true if the element has been rewritten.
	 */
	@Override
	public final boolean applyTo(final Element link, final String linkAttr) {
<span class="fc" id="L83">	    String url = link.getAttribute(linkAttr);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">	    if (&quot;date:&quot;.equals(url)) {</span>
<span class="fc" id="L85">	        String rawDateTime = link.getTextContent();</span>
	        
<span class="fc" id="L87">	        String formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L88">	        String startTimeAttr = &quot;&quot;;</span>
<span class="fc" id="L89">	        String endTimeAttr = &quot;&quot;;</span>
<span class="fc" id="L90">	        ZoneId timeZone = ZoneId.systemDefault();</span>
<span class="fc" id="L91">	        DateTimeFormatter formatter = DateTimeFormatter.ISO_LOCAL_DATE_TIME;</span>
	        try {
<span class="fc" id="L93">	            LocalDateTime dateTime = LocalDateTime.parse(rawDateTime, </span>
	                    formatter);
<span class="fc" id="L95">	            ZonedDateTime zdt  = ZonedDateTime.of(dateTime, timeZone);</span>
<span class="fc" id="L96">                formattedDateTime = DT_OUTPUT_FORMAT.format(zdt);</span>
<span class="fc" id="L97">	            startTimeAttr = DT_ATTR_FORMAT.format(zdt);</span>
	             
<span class="fc" id="L99">	            TemporalAccessor endDT = processEndDate(link, linkAttr);</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">	            if (endDT != null) {</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">	                if (endDT instanceof LocalDateTime) {</span>
<span class="fc" id="L102">	                    LocalDateTime ldt = (LocalDateTime) endDT;</span>
<span class="fc" id="L103">                        LocalDate dt0 = dateTime.toLocalDate();</span>
<span class="fc" id="L104">                        LocalDate dt1 = ldt.toLocalDate();</span>
                        String formattedEndTime;
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">                        if (dt0.equals(dt1)) {</span>
<span class="nc" id="L107">                            formattedEndTime =  T_OUTPUT_FORMAT.format(ldt);</span>
                        } else {
<span class="fc" id="L109">                            formattedEndTime = DT_OUTPUT_FORMAT.format(</span>
<span class="fc" id="L110">                                    ZonedDateTime.of(ldt, timeZone));</span>
                        }
<span class="fc" id="L112">                        formattedDateTime = formattedDateTime + &quot; - &quot; </span>
                            + formattedEndTime;
<span class="fc" id="L114">                        endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="fc" id="L115">                                ZonedDateTime.of(ldt, timeZone));</span>
<span class="pc bnc" id="L116" title="All 2 branches missed.">                    } else if (endDT instanceof LocalDate) {</span>
<span class="nc" id="L117">                        String formattedEndTime = D_OUTPUT_FORMAT.format(endDT);</span>
<span class="nc" id="L118">                        formattedDateTime = formattedDateTime + &quot; - &quot; </span>
                            + formattedEndTime;
<span class="nc" id="L120">                        LocalDateTime eldt = ((LocalDate) endDT)</span>
<span class="nc" id="L121">                                .atTime(23, 59, 59);</span>
<span class="nc" id="L122">                        endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="nc" id="L123">                                ZonedDateTime.of(eldt, timeZone));                        </span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">                    } else if (endDT instanceof LocalTime) {</span>
<span class="nc" id="L125">                        String formattedEndTime = T_OUTPUT_FORMAT.format(endDT);</span>
<span class="nc" id="L126">                        formattedDateTime = formattedDateTime + &quot;-&quot; </span>
                            + formattedEndTime;
<span class="nc" id="L128">                        LocalDateTime eldt = dateTime.toLocalDate()</span>
<span class="nc" id="L129">                                .atTime((LocalTime)endDT);</span>
<span class="nc" id="L130">                        endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="nc" id="L131">                                ZonedDateTime.of(eldt, timeZone));                        </span>
<span class="nc" id="L132">                    } else {</span>
<span class="nc" id="L133">                        logger.error(&quot;Obtained endDate of unhandled type &quot; </span>
<span class="nc" id="L134">                                       + endDT.getClass().getName());</span>
                    }
	            } else {
<span class="fc" id="L137">	                LocalDateTime eldt = dateTime.plusMinutes(1);</span>
<span class="fc" id="L138">                    endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="fc" id="L139">                            ZonedDateTime.of(eldt,  timeZone));                        </span>
	            }
<span class="fc" id="L141">	        } catch (DateTimeParseException ex) {</span>
<span class="fc" id="L142">	            formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L143">	        }</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">            if (formattedDateTime.length() == 0) {</span>
<span class="fc" id="L145">                formatter = DateTimeFormatter.ISO_LOCAL_DATE;</span>
                try {
<span class="fc" id="L147">                    LocalDate date = LocalDate.parse(rawDateTime, </span>
                            formatter);
<span class="fc" id="L149">                    LocalDateTime dateTime = date.atTime(0,0,0);</span>
<span class="fc" id="L150">                    ZonedDateTime zdt  = ZonedDateTime.of(dateTime, timeZone);</span>
<span class="fc" id="L151">                    formattedDateTime = D_OUTPUT_FORMAT.format(zdt);</span>
<span class="fc" id="L152">                    startTimeAttr = DT_ATTR_FORMAT.format(zdt);</span>
                
<span class="fc" id="L154">                    TemporalAccessor endDT = processEndDate(link, linkAttr);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">                    if (endDT != null) {</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">                        if (endDT instanceof LocalDateTime) {</span>
<span class="nc" id="L157">                            LocalDateTime ldt = (LocalDateTime) endDT;</span>
<span class="nc" id="L158">                            String formattedEndTime =  </span>
<span class="nc" id="L159">                                    D_OUTPUT_FORMAT.format(ldt);</span>
<span class="nc" id="L160">                            formattedDateTime = formattedDateTime + &quot; - &quot; </span>
                                + formattedEndTime;
<span class="nc" id="L162">                            endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="nc" id="L163">                                    ZonedDateTime.of(ldt, timeZone));</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                        } else if (endDT instanceof LocalDate) {</span>
<span class="fc" id="L165">                            String formattedEndTime = </span>
<span class="fc" id="L166">                                    D_OUTPUT_FORMAT.format(endDT);</span>
<span class="fc" id="L167">                            formattedDateTime = formattedDateTime + &quot; - &quot; </span>
                                + formattedEndTime;
<span class="fc" id="L169">                            LocalDateTime eldt = ((LocalDate) endDT)</span>
<span class="fc" id="L170">                                    .atTime(23, 59, 59);</span>
<span class="fc" id="L171">                            endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="fc" id="L172">                                    ZonedDateTime.of(eldt, timeZone));                        </span>
<span class="pc bnc" id="L173" title="All 2 branches missed.">                        } else if (endDT instanceof LocalTime) {</span>
<span class="nc" id="L174">                            logger.warn</span>
<span class="nc" id="L175">                                (&quot;Cannot combine a pure starting date (&quot;</span>
                                    + formattedDateTime
                                    + &quot;) with an ending time.&quot;);
<span class="nc" id="L178">                            LocalDateTime eldt = dateTime.toLocalDate()</span>
<span class="nc" id="L179">                                    .atTime((LocalTime)endDT);</span>
<span class="nc" id="L180">                            endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="nc" id="L181">                                    ZonedDateTime.of(eldt, timeZone));                        </span>
<span class="nc" id="L182">                        } else {</span>
<span class="nc" id="L183">                            logger.error(&quot;Obtained endDate of unhandled type &quot; </span>
<span class="nc" id="L184">                                           + endDT.getClass().getName());</span>
                        }
                    } else {
<span class="fc" id="L187">                        LocalDateTime eldt = date.atTime(23, 59, 59);</span>
<span class="fc" id="L188">                        endTimeAttr = DT_ATTR_FORMAT.format(</span>
<span class="fc" id="L189">                                ZonedDateTime.of(eldt, timeZone));                                                </span>
                    }
<span class="fc" id="L191">                } catch (DateTimeParseException ex) {</span>
<span class="fc" id="L192">                    formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L193">                }</span>
            }
<span class="fc bfc" id="L195" title="All 2 branches covered.">	        if (formattedDateTime.length() == 0) {</span>
<span class="fc" id="L196">	            formatter = DateTimeFormatter.ISO_LOCAL_TIME;</span>
	            try {
<span class="fc" id="L198">	                LocalTime time = LocalTime.parse(rawDateTime, </span>
	                        formatter);
<span class="fc" id="L200">	                formattedDateTime = T_OUTPUT_FORMAT.format(time);</span>
	                        
<span class="fc" id="L202">                    TemporalAccessor endDT = processEndDate(link, linkAttr);</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">                    if (endDT != null) {</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                        if (endDT instanceof LocalDateTime) {</span>
<span class="nc" id="L205">                            logger.warn</span>
<span class="nc" id="L206">                            (&quot;Cannot combine a pure starting time (&quot;</span>
                                + formattedDateTime
                                + &quot;) with an ending date.&quot;);
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">                        } else if (endDT instanceof LocalDate) {</span>
<span class="nc" id="L210">                            logger.warn</span>
<span class="nc" id="L211">                            (&quot;Cannot combine a pure starting time (&quot;</span>
                                + formattedDateTime
                                + &quot;) with an ending date.&quot;);
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">                        } else if (endDT instanceof LocalTime) {</span>
<span class="fc" id="L215">                            String formattedEndTime </span>
<span class="fc" id="L216">                                = T_OUTPUT_FORMAT.format(endDT);</span>
<span class="fc" id="L217">                            formattedDateTime = formattedDateTime + &quot;-&quot; </span>
                                + formattedEndTime;
<span class="fc" id="L219">                        } else {</span>
<span class="nc" id="L220">                            logger.error(&quot;Obtained endDate of unhandled type &quot; </span>
<span class="nc" id="L221">                                           + endDT.getClass().getName());</span>
                        }
                    }
<span class="nc" id="L224">	            } catch (DateTimeParseException ex) {</span>
<span class="nc" id="L225">	                formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L226">	            }</span>
	        }
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">	        if (formattedDateTime.length() &gt; 0) {</span>
<span class="fc" id="L229">	            Document doc = link.getOwnerDocument();</span>
<span class="fc" id="L230">	            Element span = doc.createElement(&quot;span&quot;);</span>
<span class="fc" id="L231">	            NamedNodeMap attrs = link.getAttributes();</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">	            for (int i = 0; i &lt; attrs.getLength(); i++) {</span>
<span class="fc" id="L233">	              Attr attr2 = (Attr) doc.importNode(attrs.item(i), true);</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">	              if (!attr2.getName().equals(&quot;href&quot;)) {</span>
<span class="nc" id="L235">	                  span.getAttributes().setNamedItem(attr2);</span>
	              }
	            }
<span class="fc" id="L238">	            span.setAttribute(&quot;class&quot;, &quot;date&quot;);</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">	            if (startTimeAttr.length() &gt; 0) {</span>
<span class="fc" id="L240">	                span.setAttribute(&quot;startsAt&quot;, startTimeAttr);</span>
	            }
<span class="fc bfc" id="L242" title="All 2 branches covered.">                if (endTimeAttr.length() &gt; 0) {</span>
<span class="fc" id="L243">                    span.setAttribute(&quot;endsAt&quot;, endTimeAttr);</span>
                }
<span class="fc" id="L245">	            span.appendChild(doc.createTextNode(formattedDateTime));</span>
<span class="fc" id="L246">	            link.getParentNode().replaceChild(span, link);</span>
<span class="fc" id="L247">	            return true;</span>
	        } else {
<span class="nc" id="L249">	            logger.warn(&quot;Could not interpret date: &quot; + url);</span>
	        }
	    }
<span class="fc" id="L252">	    return false;</span>
	}
     	    
     	    
    /**
     * Checks to see if an endDate: linking element follows the dateElement
     * and, if so, attempts to rewrite the element.
     * 
     * @param dateElement an element containing a date: URL
     * @param linkAttr name of the attribute containing the URL 
     * @return Date/Time associated with the endDate item if found, null if
     *          no endDate: link was found
     */
    private TemporalAccessor processEndDate(
            final Element dateElement, 
            final String linkAttr) {

<span class="fc" id="L269">        TemporalAccessor result = null;</span>
        
<span class="fc" id="L271">        Node n = dateElement.getNextSibling();</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">        while (n != null) {</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">            if (&quot;a&quot;.equals(n.getNodeName())) {</span>
<span class="fc" id="L274">                String url = ((Element) n).getAttribute(linkAttr);</span>
<span class="pc bpc" id="L275" title="2 of 4 branches missed.">                if (&quot;endDate:&quot;.equals(url) || &quot;enddate:&quot;.equals(url)) {</span>
<span class="fc" id="L276">                    break;</span>
                }
            }
<span class="fc" id="L279">            n = n.getNextSibling();</span>
        }
<span class="fc bfc" id="L281" title="All 2 branches covered.">        if (n == null) {</span>
<span class="fc" id="L282">            return null;</span>
        }
        
<span class="fc" id="L285">        Element link = (Element) n;</span>
<span class="fc" id="L286">        String url = link.getAttribute(linkAttr);</span>

<span class="fc" id="L288">        String rawDateTime = link.getTextContent();</span>
            
<span class="fc" id="L290">        DateTimeFormatter formatter = DateTimeFormatter.ISO_LOCAL_DATE_TIME;</span>
        try {
<span class="fc" id="L292">            result = LocalDateTime.parse(rawDateTime, </span>
                    formatter);                        
<span class="fc" id="L294">        } catch (DateTimeParseException ex) {</span>
<span class="fc" id="L295">            result = null;</span>
<span class="fc" id="L296">        }</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if (result == null) {</span>
<span class="fc" id="L298">            formatter = DateTimeFormatter.ISO_LOCAL_DATE;</span>
            try {
<span class="fc" id="L300">                result = LocalDate.parse(rawDateTime, </span>
                        formatter);
<span class="fc" id="L302">            } catch (DateTimeParseException ex) {</span>
<span class="fc" id="L303">                result = null;</span>
<span class="fc" id="L304">            }</span>
        }
<span class="fc bfc" id="L306" title="All 2 branches covered.">        if (result == null) {</span>
<span class="fc" id="L307">            formatter = DateTimeFormatter.ISO_LOCAL_TIME;</span>
            try {
<span class="fc" id="L309">                result = LocalTime.parse(rawDateTime, formatter);                            </span>
<span class="nc" id="L310">            } catch (DateTimeParseException ex) {</span>
<span class="nc" id="L311">                result = null;</span>
<span class="fc" id="L312">            }</span>
        }
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        if (result != null) {</span>
<span class="fc" id="L315">            Document doc = link.getOwnerDocument();</span>
<span class="fc" id="L316">            Node parent = link.getParentNode();</span>
<span class="fc" id="L317">            parent.removeChild(link);</span>
<span class="fc" id="L318">        } else {</span>
<span class="nc" id="L319">            logger.warn(&quot;Could not interpret end date: &quot; + url);</span>
        }
<span class="fc" id="L321">        return result;</span>
    }

    
    
    
     	    

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>