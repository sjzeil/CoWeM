<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DueDateURLs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cowem-plugin</a> &gt; <a href="index.source.html" class="el_package">edu.odu.cs.cowem.documents.urls</a> &gt; <span class="el_source">DueDateURLs.java</span></div><h1>DueDateURLs.java</h1><pre class="source lang-java linenums">package edu.odu.cs.cowem.documents.urls;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NamedNodeMap;

/**
 * Implements URL rewriting in course documents.
 * 
 *  [text](due:) where text is a date/time in ISO 8601 format
 *           YYYY-MM-DDThh:mm, is formatted so a span of class
 *           date with a more conventional format, preceded by &quot;Due: &quot;.
 * 
 *  No support at the moment for time zones. May add that later.
 *  
 * @author zeil
 *
 */
public class DueDateURLs implements SpecialURL {
    
     
    /**
     * For logging error messages.
     */
<span class="fc" id="L36">    private static Logger logger </span>
<span class="fc" id="L37">       = LoggerFactory.getLogger(DueDateURLs.class);</span>
    
    /**
     * Format used for rendering combined date-time attributes.
     */
<span class="fc" id="L42">    private static final DateTimeFormatter DT_ATTR_FORMAT </span>
<span class="fc" id="L43">        = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss z&quot;);</span>


    /**
     * Create a URL rewriter.
     * 
     */
<span class="fc" id="L50">    public DueDateURLs() {</span>
<span class="fc" id="L51">    }</span>

 
	/**
	 * Checks to see if a linking element (a or img) uses a special
	 * protocol label and, if so, attempts to rewrite the element.
	 * 
     * @param link an element containing a URL
     * @param linkAttr name of the attribute containing the URL 
     * @return true if the element has been rewritten.
	 */
	@Override
	public final boolean applyTo(final Element link, final String linkAttr) {
<span class="fc" id="L64">	    String url = link.getAttribute(linkAttr);</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">	    if (&quot;due:&quot;.equals(url)) {</span>
<span class="fc" id="L66">	        String rawDateTime = link.getTextContent();</span>
	        
<span class="fc" id="L68">	        String formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L69">	        String startTimeAttr = &quot;&quot;;</span>
<span class="fc" id="L70">	        String endTimeAttr = &quot;&quot;;</span>
<span class="fc" id="L71">	        ZoneId timeZone = ZoneId.systemDefault();</span>

<span class="fc" id="L73">	        DateTimeFormatter formatter = DateTimeFormatter.ISO_LOCAL_DATE_TIME;</span>
	        try {
<span class="fc" id="L75">	            LocalDateTime dateTime = LocalDateTime.parse(rawDateTime, </span>
	                    formatter);
<span class="fc" id="L77">	            DateTimeFormatter outputFormat = DateTimeFormatter.ofPattern(</span>
	                    &quot;MM/dd/yyyy, h:mma z&quot;);
<span class="fc" id="L79">	            ZonedDateTime zdt  = ZonedDateTime.of(dateTime, timeZone);</span>
<span class="fc" id="L80">	            formattedDateTime = &quot;Due: &quot; + outputFormat.format(zdt);</span>
<span class="fc" id="L81">                startTimeAttr = DT_ATTR_FORMAT.format(zdt);</span>
<span class="fc" id="L82">	            ZonedDateTime zedt = zdt.plusMinutes(1);</span>
<span class="fc" id="L83">	            endTimeAttr = DT_ATTR_FORMAT.format(zedt);</span>
                
<span class="fc" id="L85">	        } catch (DateTimeParseException ex) {</span>
<span class="fc" id="L86">	            formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L87">	        }</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">            if (formattedDateTime.length() == 0) {</span>
<span class="fc" id="L89">                formatter = DateTimeFormatter.ISO_LOCAL_DATE;</span>
                try {
<span class="fc" id="L91">                    LocalDate date = LocalDate.parse(rawDateTime, </span>
                            formatter);
<span class="fc" id="L93">                    DateTimeFormatter outputFormat = </span>
<span class="fc" id="L94">                            DateTimeFormatter.ofPattern(</span>
                               &quot;MM/dd/yyyy&quot;);
<span class="fc" id="L96">                    formattedDateTime = &quot;Due: &quot; + outputFormat.format(date);</span>
<span class="fc" id="L97">                    LocalDateTime dateTime = date.atTime(23,58,59);</span>
<span class="fc" id="L98">                    ZonedDateTime zdt  = ZonedDateTime.of(dateTime, timeZone);</span>
<span class="fc" id="L99">                    startTimeAttr = DT_ATTR_FORMAT.format(zdt);</span>
<span class="fc" id="L100">                    ZonedDateTime zedt = zdt.plusMinutes(1);</span>
<span class="fc" id="L101">                    endTimeAttr = DT_ATTR_FORMAT.format(zedt);</span>
                            
<span class="fc" id="L103">                } catch (DateTimeParseException ex) {</span>
<span class="fc" id="L104">                    formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L105">                }</span>
            }
<span class="fc bfc" id="L107" title="All 2 branches covered.">	        if (formattedDateTime.length() == 0) {</span>
<span class="fc" id="L108">	            formatter = DateTimeFormatter.ISO_LOCAL_TIME;</span>
	            try {
<span class="fc" id="L110">	                LocalTime time = LocalTime.parse(rawDateTime, </span>
	                        formatter);
<span class="fc" id="L112">	                DateTimeFormatter outputFormat = </span>
<span class="fc" id="L113">	                        DateTimeFormatter.ofPattern(</span>
	                           &quot;h:mma&quot;);
<span class="fc" id="L115">	                formattedDateTime = &quot;Due: &quot; + outputFormat.format(time);</span>
	                        
<span class="nc" id="L117">	            } catch (DateTimeParseException ex) {</span>
<span class="nc" id="L118">	                formattedDateTime = &quot;&quot;;</span>
<span class="fc" id="L119">	            }</span>
	        }
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">	        if (formattedDateTime.length() &gt; 0) {</span>
<span class="fc" id="L122">	            Document doc = link.getOwnerDocument();</span>
<span class="fc" id="L123">	            Element span = doc.createElement(&quot;span&quot;);</span>
<span class="fc" id="L124">                NamedNodeMap attrs = link.getAttributes();</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">                for (int i = 0; i &lt; attrs.getLength(); i++) {</span>
<span class="fc" id="L126">                  Attr attr2 = (Attr) doc.importNode(attrs.item(i), true);</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">                  if (!attr2.getName().equals(&quot;href&quot;)) {</span>
<span class="nc" id="L128">                      span.getAttributes().setNamedItem(attr2);</span>
                  }
                }
<span class="fc" id="L131">                span.setAttribute(&quot;class&quot;, &quot;date&quot;);</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">                if (startTimeAttr.length() &gt; 0) {</span>
<span class="fc" id="L133">                    span.setAttribute(&quot;startsAt&quot;, startTimeAttr);</span>
                }
<span class="fc bfc" id="L135" title="All 2 branches covered.">                if (endTimeAttr.length() &gt; 0) {</span>
<span class="fc" id="L136">                    span.setAttribute(&quot;endsAt&quot;, endTimeAttr);</span>
                }
<span class="fc" id="L138">	            span.appendChild(doc.createTextNode(formattedDateTime));</span>
<span class="fc" id="L139">	            link.getParentNode().replaceChild(span, link);</span>
<span class="fc" id="L140">	            return true;</span>
	        } else {
<span class="nc" id="L142">	            logger.warn(&quot;Unable to parse due date: &quot; + rawDateTime);</span>
	        }
	    }
<span class="fc" id="L145">	    return false;</span>
	}
     	   	
     	    

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>